#!/usr/bin/env bash
set -euo pipefail

# Configurable vars (override via environment if needed)
REMOTE_USER="${REMOTE_USER:-its}"
REMOTE_HOST="${REMOTE_HOST:-172.16.100.97}"
KEY_PATH="${KEY_PATH:-$HOME/.ssh/id_ed25519}"
PUB_KEY="${KEY_PATH}.pub"

# Handle command line arguments for user:octet or just octet
if [[ $# -gt 0 ]]; then
  if [[ "$1" =~ ^([a-zA-Z0-9._-]+):([0-9]+)$ ]]; then
    REMOTE_USER="${BASH_REMATCH[1]}"
    REMOTE_HOST="172.16.100.${BASH_REMATCH[2]}"
    shift
  elif [[ "$1" =~ ^([0-9]+)$ ]]; then
    REMOTE_HOST="172.16.100.$1"
    shift
  fi
fi

ensure_local_key() {
  mkdir -p "$HOME/.ssh"
  chmod 700 "$HOME/.ssh"
  if [[ ! -f "$KEY_PATH" || ! -f "$PUB_KEY" ]]; then
    echo "Generating SSH key at $KEY_PATH (ed25519, empty passphrase)..."
    ssh-keygen -t ed25519 -f "$KEY_PATH" -N "" -C "${REMOTE_USER}@${REMOTE_HOST}-$(hostname -s)" >/dev/null
  fi
  chmod 600 "$KEY_PATH"
  chmod 644 "$PUB_KEY"
}

copy_key_with_ssh_copy_id() {
  echo "Copying key to ${REMOTE_USER}@${REMOTE_HOST} using ssh-copy-id..."
  ssh-copy-id -i "$PUB_KEY" "${REMOTE_USER}@${REMOTE_HOST}"
}

copy_key_manually() {
  echo "Copying key to ${REMOTE_USER}@${REMOTE_HOST} without ssh-copy-id..."
  local key_content
  key_content=$(cat "$PUB_KEY")
  # The following will prompt for the remote password on first run.
  ssh "${REMOTE_USER}@${REMOTE_HOST}" "mkdir -p ~/.ssh && chmod 700 ~/.ssh && touch ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys && grep -qxF '$key_content' ~/.ssh/authorized_keys || echo '$key_content' >> ~/.ssh/authorized_keys"
}

key_works() {
  ssh -o BatchMode=yes -i "$KEY_PATH" "${REMOTE_USER}@${REMOTE_HOST}" true >/dev/null 2>&1
}

connect() {
  exec ssh -X -i "$KEY_PATH" "${REMOTE_USER}@${REMOTE_HOST}" "$@"
}

main() {
  ensure_local_key
  if ! key_works; then
    if command -v ssh-copy-id >/dev/null 2>&1; then
      copy_key_with_ssh_copy_id || true
    else
      copy_key_manually || true
    fi
  fi
  connect "$@"
}

main "$@"
